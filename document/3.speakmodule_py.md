말하는 기능
======

speakmodule.py의 기능을 다룬다.

우선 필요한 라이브러리들을 설치해주자.

    import os
    import sys
    from google.cloud import texttospeech
    from playsound import playsound # 음성 재생을 위해 playsound 사용
    import tempfile # 임시 파일 생성을 위해 필요
    import time
    import json

버전은 기억이 나지 않지만 이 라이브러리들을 설치하자.

    if getattr(sys, 'frozen', False):
        BASE_DIR = sys._MEIPASS
    else:
        BASE_DIR = os.path.dirname(os.path.abspath(__file__))
    
    KEY = os.path.join(BASE_DIR, "boss-tts-key.json")
    os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = KEY

이것은 키의 파일 경로를 지정해주는 것이다. 앱에서 오류가 일어나지 않도록 모든 파일을 불러올때는 항상 이런 형태의 절대경로 지정을 해줘야한다. AI가 짜줘서 사실 잘 모르겠다.

이제 말하기 함수를 살펴보자.

    def speak(text):
        setting = json.load(open(os.path.join(BASE_DIR, 'setting.json')))
        gender_str = setting['gender'].upper()
        ssml_gender_enum = getattr(texttospeech.SsmlVoiceGender, gender_str)
        temp_file_path = None

설정값은 json으로 불러오기 때문에 말할 텍스트만 입력받으면 된다.

    try:
            client = texttospeech.TextToSpeechClient()
            synthesis_input = texttospeech.SynthesisInput(text=text)
            voice = texttospeech.VoiceSelectionParams(
                language_code=setting['model'][0:5],
                name=setting['model'], 
                ssml_gender=ssml_gender_enum # FEMALE, MALE, NEUTRAL 중 선택
            )
            audio_config = texttospeech.AudioConfig(
                audio_encoding=texttospeech.AudioEncoding.MP3,
                speaking_rate=setting['rate'], # 속도 옵션 적용
                pitch=0.0,                 # 음높이 옵션 적용
                volume_gain_db=0.0 # 볼륨 옵션 적용
            )
    
            response = client.synthesize_speech(
                input=synthesis_input, voice=voice, audio_config=audio_config
            )
    
            with tempfile.NamedTemporaryFile(suffix=".mp3", delete=False) as temp_mp3_file:
                temp_mp3_file.write(response.audio_content)
                temp_file_path = temp_mp3_file.name # 임시 파일의 전체 경로를 얻습니다.
    
            playsound(temp_file_path) 

사실 직접 말하는것이 아니라 음성이 담긴 mp3파일을 저장하고 이를 즉시 재생 후 삭제하는것이다. 이걸 빨리해서 마치 바로 말하는것처럼 들리는것이다. AI가 짜준 구조이므로 건드릴 필요가 없다. 우리가 건드릴 부분은 설정값뿐.

    voice = texttospeech.VoiceSelectionParams(
                    language_code=setting['model'][0:5],
                    name=setting['model'], 
                    ssml_gender=ssml_gender_enum # FEMALE, MALE, NEUTRAL 중 선택
                )

목소리 설정

    audio_config = texttospeech.AudioConfig(
                    audio_encoding=texttospeech.AudioEncoding.MP3,
                    speaking_rate=setting['rate'], # 속도 옵션 적용
                    pitch=0.0,                 # 음높이 옵션 적용
                    volume_gain_db=0.0 # 볼륨 옵션 적용
                )

음성 설정이다. 만약 모델이 Chirp가 아니라 Neural, Wavenet 등 피치와 볼륨조절을 지원한다면 json파일에서 설정값을 가져오면 된다. rate 가져오듯 똑같이 하자.

    except Exception as e: # 여기를 변경했습니다.
            print(f"음성 합성 오류: {e}")
        finally:
            if temp_file_path and os.path.exists(temp_file_path):
                try:
                    # playsound가 파일 핸들을 완전히 해제할 시간을 주기 위해 짧은 지연을 줍니다.
                    time.sleep(0.1) 
                    os.remove(temp_file_path)
                except Exception as e:
                    print(f"⚠️ 임시 파일 삭제 실패: {e}")

이부분은 간단하다. 오류가 일어나면 오류메시지를 발송하고 만약 잘 진행되면 생성한 mp3파일을 삭제하는 것이다. 사실 print로 하면 앱을 실행했을때 오류메시지를 볼수 없으므로 return을 이용해야 하지만 수정하기 귀찮으므로 후대에 넘기도록 하겠다.
